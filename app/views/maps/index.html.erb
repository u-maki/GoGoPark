<!-- app/views/maps/index.html.erb -->
<!DOCTYPE html>
<html>
<head>
  <title>Nearby Parks</title>
  <style>
    /* 地図のサイズを指定 */
    #map {
      height: 400px;
      width: 100%;
    }

    /* 公園リストのスタイル */
    #parks-list {
      margin-top: 20px;
    }

    .park-item {
      padding: 10px;
      border: 1px solid #ddd;
      margin-bottom: 10px;
    }

    .park-item h3 {
      margin: 0;
      font-size: 18px;
    }

    .park-item p {
      margin: 5px 0;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>現在地周辺の公園</h1>
  <div id="map"></div>

  <!-- 公園リスト表示用のdiv -->
  <div id="parks-list"></div>

  <script>
    function initMap() {
      // 現在地を取得
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          var userLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };

          // 地図の表示
          var map = new google.maps.Map(document.getElementById('map'), {
            center: userLocation,
            zoom: 14
          });

          // 現在地にマーカーを追加
          var marker = new google.maps.Marker({
            position: userLocation,
            map: map,
            title: "あなたの位置"
          });

          // Places APIを使って周辺の公園を取得
          var service = new google.maps.places.PlacesService(map);
          var request = {
            location: userLocation,
            radius: 5000, // 5km圏内
            type: ['park'] // 公園のみを検索
          };

          // 公園情報を取得
          service.nearbySearch(request, function(results, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
              // 公園リストのコンテナを取得
              var parksList = document.getElementById('parks-list');
              parksList.innerHTML = "<h2>近くの公園:</h2>"; // リストタイトル

              // 公園を地図に表示し、リストにも追加
              for (var i = 0; i < results.length; i++) {
                var place = results[i];

                // 公園にマーカーを追加
                var parkMarker = new google.maps.Marker({
                  position: place.geometry.location,
                  map: map,
                  title: place.name
                });
                google.maps.event.addListener(parkMarker, 'click', function () {
            // Google Mapsの詳細ページURL
            var detailUrl = `https://www.google.com/maps/place/?q=place_id:${place.place_id}`;

            // 別のアプリ内で公園の詳細ページを作る場合
            // var detailUrl = `/parks/${place.place_id}`;

            window.location.href = detailUrl;
          });

                // 公園情報をリストに表示
                var parkItem = document.createElement('div');
                parkItem.classList.add('park-item');
                parkItem.innerHTML = `
                  <h3>${place.name}</h3>
                  <p>${place.vicinity ? place.vicinity : '住所情報はありません'}</p>
                `;
                parksList.appendChild(parkItem);
              }
            } else {
              alert("公園情報の取得に失敗しました。");
            }
          });
        });
      } else {
        alert("位置情報が取得できません。");
      }
    }

    // 地図を初期化
    window.onload = initMap;
  </script>
</body>
</html>
